# درگاه پرداخت شبیه‌سازی شده پاسارگاد

این پروژه یک شبیه‌ساز درگاه پرداخت پاسارگاد است که برای تست و توسعه اپلیکیشن‌های پرداخت استفاده می‌شود.

## هشدار مهم

**این پروژه صرفاً جنبه آموزشی و تستی دارد و هیچگونه بار حقوقی یا قانونی را متقبل نمی‌شود. استفاده از این پروژه در محیط‌های تولیدی و تجاری به هیچ وجه توصیه نمی‌شود.**

## دلایل ایجاد این پروژه

درگاه پرداخت پاسارگاد دارای محدودیت‌های زیر است که باعث ایجاد این پروژه شبیه‌سازی شده است:

1. **محدودیت دسترسی به محیط تست**: 
   - نیاز به ثبت‌نام و تایید هویت
   - محدودیت زمانی برای استفاده از محیط تست
   - نیاز به مدارک رسمی برای دسترسی

2. **محدودیت‌های فنی**:
   - نیاز به IP ثابت
   - محدودیت تعداد درخواست
   - نیاز به SSL معتبر
   - محدودیت در تست سناریوهای مختلف

3. **محدودیت‌های امنیتی**:
   - عدم امکان تست سناریوهای خطا
   - محدودیت در تست مکانیزم‌های امنیتی
   - عدم دسترسی به لاگ‌های کامل

## منبع مستندات

این پروژه بر اساس مستندات رسمی درگاه پرداخت پاسارگاد به آدرس زیر پیاده‌سازی شده است:
[مستندات رسمی درگاه پرداخت پاسارگاد](http://pep.co.ir/wp-content/uploads/2024/01/Parsa-IPG-2.pdf)

**توجه**: تمام سرویس‌ها و API‌های پیاده‌سازی شده در این پروژه، مطابق با مستندات رسمی درگاه پرداخت پاسارگاد است و در حال حاضر نیز درگاه پرداخت با همین سرویس‌ها به ارائه خدمات می‌پردازد.

## ویژگی‌ها

- شبیه‌سازی کامل API درگاه پرداخت پاسارگاد
- پشتیبانی از تمام سرویس‌های اصلی
- امکان تست سناریوهای مختلف پرداخت
- رابط کاربری ساده برای شبیه‌سازی پرداخت
- تست‌های خودکار با Postman

## پیش‌نیازها

- .NET 7.0 یا بالاتر
- Postman (برای اجرای تست‌ها)

## نصب و راه‌اندازی

1. پروژه را کلون کنید:
```bash
git clone [آدرس مخزن]
```

2. به پوشه پروژه بروید:
```bash
cd PasargadMockGateway
```

3. پروژه را اجرا کنید:
```bash
dotnet run
```

سرور روی پورت 4000 اجرا می‌شود.

## سرویس‌های موجود

### 1. دریافت توکن (GetToken)
- **آدرس**: `/token/getToken`
- **متد**: POST
- **ورودی‌ها**:
  - `Username`: نام کاربری (پیش‌فرض: `ipgTestUser`)
  - `Password`: رمز عبور (پیش‌فرض: `123456`)
- **خروجی‌ها**:
  - `Token`: توکن دسترسی
  - `ResultCode`: کد نتیجه (0 برای موفقیت)
  - `Message`: پیام نتیجه

### 2. درخواست پرداخت (Purchase)
- **آدرس**: `/api/payment/purchase`
- **متد**: POST
- **ورودی‌ها**:
  - `ServiceCode`: کد سرویس (پیش‌فرض: `8`)
  - `ServiceType`: نوع سرویس (پیش‌فرض: `PURCHASE`)
  - `PaymentCode`: کد پرداخت (هر مقدار معتبر)
  - `InvoiceNumber`: شماره فاکتور (باید یکتا باشد)
  - `Amount`: مبلغ (هر مقدار معتبر)
  - `RedirectUrl`: آدرس بازگشت (باید معتبر باشد)
- **خروجی‌ها**:
  - `Url`: آدرس صفحه پرداخت
  - `ResultCode`: کد نتیجه
  - `Message`: پیام نتیجه

### 3. تایید تراکنش (ConfirmTransaction)
- **آدرس**: `/api/payment/confirm-transactions`
- **متد**: POST
- **ورودی‌ها**:
  - `Invoice`: شماره فاکتور (باید با شماره فاکتور خرید مطابقت داشته باشد)
  - `TerminalCode`: کد ترمینال (پیش‌فرض: `123456`)
- **خروجی‌ها**:
  - `ResultCode`: کد نتیجه
  - `Message`: پیام نتیجه

### 4. استعلام وضعیت (PaymentInquiry)
- **آدرس**: `/api/payment/payment-inquiry`
- **متد**: POST
- **ورودی‌ها**:
  - `InvoiceId`: شماره فاکتور
  - `TerminalCode`: کد ترمینال
- **خروجی‌ها**:
  - `ResultCode`: کد نتیجه
  - `Message`: پیام نتیجه
  - `Data`: اطلاعات تراکنش

### 5. برگشت تراکنش (ReverseTransaction)
- **آدرس**: `/api/payment/reverse-transactions`
- **متد**: POST
- **ورودی‌ها**:
  - `Invoice`: شماره فاکتور
  - `TerminalCode`: کد ترمینال
- **خروجی‌ها**:
  - `ResultCode`: کد نتیجه
  - `Message`: پیام نتیجه

## نحوه استفاده از Postman

### 1. وارد کردن Collection
1. فایل `PasargadMockGateway.postman_collection.json` را در Postman وارد کنید
2. فایل `PasargadMockGateway.postman_test_scripts.json` را برای تست‌های خودکار وارد کنید

### 2. تنظیم متغیرها
1. یک Environment جدید در Postman ایجاد کنید
2. متغیر `baseUrl` را با مقدار `http://localhost:4000` تنظیم کنید

### 3. اجرای تست‌ها
1. Collection Runner را باز کنید
2. سناریوهای تست را انتخاب کنید
3. دکمه Run را بزنید

## سناریوهای تست

### سناریو 1: پرداخت موفق
1. دریافت توکن
2. درخواست پرداخت
3. تایید تراکنش

### سناریو 2: پرداخت ناموفق
1. دریافت توکن
2. درخواست پرداخت
3. استعلام وضعیت

### سناریو 3: برگشت تراکنش
1. دریافت توکن
2. درخواست پرداخت
3. تایید تراکنش
4. برگشت تراکنش

## نکات مهم

### مقادیر پیش‌فرض
- توکن: با هر درخواست GetToken یک توکن جدید تولید می‌شود
- کد ترمینال: همیشه `123456`
- کد سرویس: همیشه `8`
- نوع سرویس: همیشه `PURCHASE`

### مقادیر پویا
- شماره فاکتور: باید در هر درخواست یکتا باشد
- مبلغ: می‌تواند هر مقدار معتبر باشد
- آدرس بازگشت: باید یک URL معتبر باشد

### محدودیت‌ها
- توکن فقط برای 24 ساعت معتبر است
- شماره فاکتور تکراری پذیرفته نمی‌شود
- مبلغ منفی یا صفر پذیرفته نمی‌شود

## خطاهای رایج

| کد خطا | توضیح |
|--------|--------|
| 401 | توکن نامعتبر |
| 13000 | کد سرویس یا نوع سرویس نامعتبر |
| 13001 | شماره فاکتور تکراری |
| 13002 | مبلغ نامعتبر |

## توسعه‌دهندگان

- [نام توسعه‌دهنده]

## لایسنس

MIT 