# درگاه پرداخت شبیه‌سازی شده پاسارگاد

این پروژه یک شبیه‌ساز درگاه پرداخت پاسارگاد است که برای تست و توسعه اپلیکیشن‌های پرداخت استفاده می‌شود.

## هشدار مهم
این پروژه صرفاً برای اهداف آموزشی و تستی ایجاد شده است و هیچ مسئولیت قانونی را نمی‌پذیرد.

## دلایل ایجاد پروژه
1. محدودیت‌های دسترسی به محیط تست درگاه اصلی:
   - نیاز به ثبت‌نام و احراز هویت
   - محدودیت زمانی برای تست
   - نیاز به مدارک و مستندات خاص

2. محدودیت‌های فنی:
   - نیاز به IP ثابت
   - محدودیت تعداد درخواست
   - نیاز به SSL معتبر
   - محدودیت در تست سناریوهای مختلف

3. محدودیت‌های امنیتی:
   - عدم امکان تست سناریوهای خطا
   - عدم دسترسی به مکانیزم‌های امنیتی
   - عدم دسترسی به لاگ‌های کامل

## مستندات مرجع
این پروژه بر اساس مستندات رسمی درگاه پرداخت پاسارگاد پیاده‌سازی شده است:
[مستندات رسمی درگاه پرداخت پاسارگاد](https://docs.pasargad.ir/)

**توجه**: تمام سرویس‌ها و API‌های پیاده‌سازی شده در این پروژه، مطابق با مستندات رسمی درگاه پرداخت پاسارگاد است و در حال حاضر نیز درگاه پرداخت با همین سرویس‌ها به ارائه خدمات می‌پردازد.

## ویژگی‌ها

- شبیه‌سازی کامل API درگاه پرداخت پاسارگاد
- پشتیبانی از JWT برای احراز هویت
- ذخیره‌سازی اطلاعات تراکنش در حافظه
- پاکسازی خودکار تراکنش‌های قدیمی
- رابط کاربری Swagger برای تست API
- پشتیبانی از CORS

## پیش‌نیازها

- .NET 8.0 SDK
- Visual Studio 2022 یا VS Code

## نصب و راه‌اندازی

1. کلون کردن مخزن:
```bash
git clone https://github.com/MiladBhrlo/pasargad.git
cd pasargad
```

2. اجرای پروژه:
```bash
dotnet run --project PasargadMockGateway
```

3. دسترسی به Swagger UI:
```
http://localhost:4000/swagger
```

## سرویس‌ها

### احراز هویت

#### دریافت توکن
- **URL**: `/token/getToken`
- **Method**: `POST`
- **Body**:
```json
{
    "Username": "ipgTestUser",
    "Password": "123456"
}
```

### پرداخت

#### درخواست پرداخت (Purchase)
- **URL**: `/api/payment/purchase`
- **Method**: `POST`
- **Headers**: 
  - `Authorization: Bearer {token}`
- **Body**:
```json
{
    "ServiceCode": "8",
    "ServiceType": "PURCHASE",
    "PaymentCode": "123456",
    "Invoice": "INV-001",
    "Amount": 1000,
    "CallbackApi": "https://your-site.com/callback",
    "TerminalNumber": 123456
}
```
- **Response**:
```json
{
    "ResultCode": 0,
    "ResultMsg": "Successful",
    "Data": {
        "UrlId": "unique-guid",
        "Url": "http://localhost:4000/{urlId}"
    }
}
```

#### درگاه پرداخت
- **URL**: `/{urlId}`
- **Method**: `GET`
- **Description**: این URL کاربر را به صفحه شبیه‌سازی درگاه پرداخت هدایت می‌کند.

#### تایید تراکنش
- **URL**: `/api/payment/confirm-transactions`
- **Method**: `POST`
- **Headers**: 
  - `Authorization: Bearer {token}`
- **Body**:
```json
{
    "Invoice": "INV-001",
    "UrlId": "unique-guid"
}
```

## تست با Postman

1. نصب و راه‌اندازی:
   - فایل `PasargadMockGateway.postman_collection.json` را در Postman وارد کنید
   - یک محیط جدید ایجاد کنید و متغیرهای زیر را تنظیم کنید:
     - `baseUrl`: آدرس پایه API (پیش‌فرض: `http://localhost:4000`)
     - `token`: توکن دسترسی (خالی بگذارید، به صورت خودکار پر می‌شود)
     - `urlId`: شناسه URL پرداخت (خالی بگذارید، به صورت خودکار پر می‌شود)
     - `paymentUrl`: آدرس درگاه پرداخت (خالی بگذارید، به صورت خودکار پر می‌شود)
     - `referenceNumber`: شماره مرجع تراکنش (خالی بگذارید، به صورت خودکار پر می‌شود)
     - `trackId`: شناسه پیگیری تراکنش (خالی بگذارید، به صورت خودکار پر می‌شود)

2. اجرای تست‌ها:
   - ابتدا درخواست `Get Token` را اجرا کنید
     - تست‌ها بررسی می‌کنند که پاسخ معتبر است
     - توکن دریافتی به صورت خودکار در متغیر محیطی ذخیره می‌شود
   
   - سپس درخواست `Purchase` را اجرا کنید
     - تست‌ها بررسی می‌کنند که پاسخ معتبر است
     - `UrlId` و `Url` به صورت خودکار در متغیرهای محیطی ذخیره می‌شوند
   
   - درخواست `Payment Gateway` را اجرا کنید
     - تست‌ها بررسی می‌کنند که به صفحه درگاه پرداخت هدایت می‌شوید
   
   - در نهایت درخواست `Confirm Transaction` را اجرا کنید
     - تست‌ها بررسی می‌کنند که پاسخ معتبر است
     - اطلاعات تراکنش به صورت خودکار در متغیرهای محیطی ذخیره می‌شوند

3. نکات مهم:
   - تمام تست‌ها به صورت خودکار اجرا می‌شوند
   - متغیرهای محیطی به صورت خودکار مدیریت می‌شوند
   - در صورت خطا در هر مرحله، تست‌ها متوقف می‌شوند
   - می‌توانید تست‌ها را به صورت دستی یا خودکار اجرا کنید

## توسعه‌دهنده

- **نام**: میلاد بهالو
- **ایمیل**:milad.b7603@gmail.com
- **گیت‌هاب**: [miladbahaloo](https://github.com/miladbahaloo)

## لایسنس

این پروژه تحت لایسنس MIT منتشر شده است. 