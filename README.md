# درگاه پرداخت شبیه‌سازی شده پاسارگاد

این پروژه یک شبیه‌ساز درگاه پرداخت پاسارگاد است که برای تست و توسعه اپلیکیشن‌های پرداخت استفاده می‌شود.

## هشدار مهم
این پروژه صرفاً برای اهداف آموزشی و تستی ایجاد شده است و هیچ مسئولیت قانونی را نمی‌پذیرد.

## دلایل ایجاد پروژه
1. محدودیت‌های دسترسی به محیط تست درگاه اصلی:
   - نیاز به ثبت‌نام و احراز هویت
   - محدودیت زمانی برای تست
   - نیاز به مدارک و مستندات خاص

2. محدودیت‌های فنی:
   - نیاز به IP ثابت
   - محدودیت تعداد درخواست
   - نیاز به SSL معتبر
   - محدودیت در تست سناریوهای مختلف

3. محدودیت‌های امنیتی:
   - عدم امکان تست سناریوهای خطا
   - عدم دسترسی به مکانیزم‌های امنیتی
   - عدم دسترسی به لاگ‌های کامل

## مستندات مرجع
این پروژه بر اساس مستندات رسمی درگاه پرداخت پاسارگاد پیاده‌سازی شده است:
[مستندات رسمی درگاه پرداخت پاسارگاد](https://docs.pasargad.ir/)

**توجه**: تمام سرویس‌ها و API‌های پیاده‌سازی شده در این پروژه، مطابق با مستندات رسمی درگاه پرداخت پاسارگاد است و در حال حاضر نیز درگاه پرداخت با همین سرویس‌ها به ارائه خدمات می‌پردازد.

## ویژگی‌ها

- شبیه‌سازی کامل API درگاه پرداخت پاسارگاد
- پشتیبانی از تمام سرویس‌های اصلی
- امکان تست سناریوهای مختلف پرداخت
- رابط کاربری ساده برای شبیه‌سازی پرداخت
- تست‌های خودکار با Postman

## پیش‌نیازها

- .NET 7.0 یا بالاتر
- Postman (برای اجرای تست‌ها)

## نصب و راه‌اندازی

1. پروژه را کلون کنید:
```bash
git clone [https://github.com/MiladBhrlo/pasargad]
```

2. به پوشه پروژه بروید:
```bash
cd PasargadMockGateway
```

3. پروژه را اجرا کنید:
```bash
dotnet run
```

سرور روی پورت 4000 اجرا می‌شود.

## سرویس‌های موجود

### 1. دریافت توکن (GetToken)
- **آدرس**: `/token/getToken`
- **متد**: POST
- **ورودی‌ها**:
  - `Username`: نام کاربری (پیش‌فرض: `ipgTestUser`)
  - `Password`: رمز عبور (پیش‌فرض: `123456`)
- **خروجی‌ها**:
  - `Token`: توکن دسترسی
  - `ResultCode`: کد نتیجه (0 برای موفقیت)
  - `Message`: پیام نتیجه

### 2. درخواست پرداخت (Purchase)
- **آدرس**: `/api/payment/purchase`
- **متد**: POST
- **ورودی‌ها**:
  - `ServiceCode`: کد سرویس (پیش‌فرض: `8`)
  - `ServiceType`: نوع سرویس (پیش‌فرض: `PURCHASE`)
  - `PaymentCode`: کد پرداخت (برای خرید شناسه دار)
- **خروجی‌ها**:
  - `UrlId`: شناسه یکتای URL
  - `Url`: آدرس درگاه پرداخت

### 3. صفحه درگاه پرداخت
- **آدرس**: `/{urlId}`
- **متد**: GET
- **پارامترهای URL**:
  - `token`: توکن تراکنش
  - `invoiceNumber`: شماره فاکتور
  - `terminalCode`: کد ترمینال
  - `amount`: مبلغ تراکنش
  - `redirectUrl`: آدرس بازگشت
- **توضیحات**:
  - این صفحه شامل دو دکمه برای شبیه‌سازی پرداخت موفق و ناموفق است
  - پس از کلیک روی هر دکمه، کاربر به آدرس `redirectUrl` هدایت می‌شود
  - در صورت پرداخت موفق، پارامتر `status=success` به آدرس بازگشت اضافه می‌شود
  - در صورت پرداخت ناموفق، پارامتر `status=failed` به آدرس بازگشت اضافه می‌شود

### 4. تایید تراکنش (ConfirmTransaction)
- **آدرس**: `/api/payment/confirm-transactions`
- **متد**: POST
- **ورودی‌ها**:
  - `Invoice`: شماره فاکتور
- **خروجی‌ها**:
  - `ResultCode`: کد نتیجه (0 برای موفقیت)
  - `Message`: پیام نتیجه
  - `Data`: اطلاعات تراکنش

### 5. استعلام وضعیت پرداخت (PaymentInquiry)
- **آدرس**: `/api/payment/payment-inquiry`
- **متد**: POST
- **ورودی‌ها**:
  - `InvoiceId`: شماره فاکتور
  - `TerminalCode`: کد ترمینال
- **خروجی‌ها**:
  - `ResultCode`: کد نتیجه (0 برای موفقیت)
  - `Message`: پیام نتیجه
  - `Data`: اطلاعات تراکنش

### 6. برگشت تراکنش (ReverseTransaction)
- **آدرس**: `/api/payment/reverse-transactions`
- **متد**: POST
- **ورودی‌ها**:
  - `Invoice`: شماره فاکتور
  - `TerminalCode`: کد ترمینال
- **خروجی‌ها**:
  - `ResultCode`: کد نتیجه (0 برای موفقیت)
  - `Message`: پیام نتیجه

## استفاده از Postman

1. فایل‌های کالکشن و تست را از پوشه `postman` وارد کنید
2. متغیرهای محیطی را تنظیم کنید:
   - `baseUrl`: آدرس پایه API (پیش‌فرض: `http://localhost:4000`)
   - `token`: توکن دسترسی (پس از دریافت از سرویس GetToken)
3. تست‌ها را اجرا کنید

## سناریوهای تست

### 1. پرداخت موفق
1. دریافت توکن
2. درخواست پرداخت
3. هدایت به صفحه درگاه پرداخت
4. کلیک روی دکمه پرداخت موفق
5. تایید تراکنش

### 2. پرداخت ناموفق
1. دریافت توکن
2. درخواست پرداخت
3. هدایت به صفحه درگاه پرداخت
4. کلیک روی دکمه پرداخت ناموفق
5. بررسی وضعیت تراکنش

### 3. برگشت تراکنش
1. دریافت توکن
2. درخواست پرداخت
3. هدایت به صفحه درگاه پرداخت
4. کلیک روی دکمه پرداخت موفق
5. تایید تراکنش
6. درخواست برگشت تراکنش

## نکات مهم

### مقادیر پیش‌فرض
- نام کاربری: `ipgTestUser`
- رمز عبور: `123456`
- کد سرویس: `8`
- نوع سرویس: `PURCHASE`

### مقادیر پویا
- شماره فاکتور: باید یکتا باشد
- مبلغ: باید عدد مثبت باشد
- آدرس بازگشت: باید معتبر باشد

### محدودیت‌ها
- داده‌ها در دیتابیس ذخیره نمی‌شوند
- اعتبارسنجی‌های امنیتی واقعی انجام نمی‌شود
- برخی کدهای خطای خاص درگاه اصلی پشتیبانی نمی‌شود

## خطاهای رایج

| کد خطا | توضیحات |
|--------|----------|
| 401 | مجاز به استفاده از سرویس نیستید |
| 13000 | پارامترهای ورودی نامعتبر است |
| 13016 | تراکنشی یافت نشد |
| 13022 | تراکنش پرداخت نشده است |
| 13030 | تراکنش تایید شده و ناموفق است |
| 13031 | تراکنش منتظر تایید است |
| 13033 | تراکنش تایید شده است |

## توسعه‌دهندگان

- [Milad Bahaloo]

## لایسنس

MIT 